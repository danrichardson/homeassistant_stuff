# automation_solar_dump_when_full.yaml
- id: '1721399007371'
  alias: Solar Dump When Full
  description: If Battery > 88%, and dining room > 75 deg F, and power differential > 1000w, run the AC for 30 mins.
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.ac300_1_total_battery_percent_2
      for:
        hours: 0
        minutes: 0
        seconds: 0
      above: 88
  condition:
    - condition: numeric_state
      entity_id: sensor.dining_room_current_temperature
      above: 70
    - condition: numeric_state
      entity_id: sensor.ac300_1_total_battery_percent_2
      above: 80
      enabled: false
    - condition: numeric_state
      entity_id: sensor.power_differential_ac300_1
      above: 1000
  action:
    - alias: Set up variables to make action events unique
      variables:
        action_yes: '{{ ''YES_'' ~ context.id }}'
        action_no: '{{ ''NO_'' ~ context.id }}'
    - alias: Send actionable notification
      service: notify.mobile_app_phonetonia
      data:
        message: Battery Fully Charged, turn on AC?
        data:
          actions:
            - action: '{{ action_yes }}'
              title: 'Yes'
            - action: '{{ action_no }}'
              title: 'No'
    - wait_for_trigger:
        - platform: event
          event_type: mobile_app_notification_action
          event_data:
            action: '{{ action_yes }}'
        - platform: event
          event_type: mobile_app_notification_action
          event_data:
            action: '{{ action_no }}'
      continue_on_timeout: false
    - alias: Do something in response to selecting an action
      choose:
        - alias: Yes action was selected
          conditions:
            - condition: template
              value_template: '{{ wait.trigger.event.data.action == action_yes }}'
          sequence:
            - service: notify.mobile_app_phonetonia
              data:
                message: Turning on Furnace Intake AC
            - service: climate.set_hvac_mode
              data:
                hvac_mode: cool
              target:
                entity_id:
                  - climate.151732605274240_climate
            - delay:
                minutes: 30
            - service: climate.set_hvac_mode
              data:
                hvac_mode: 'off'
              target:
                entity_id: climate.151732605274240_climate
        - alias: No action was selected
          conditions:
            - condition: template
              value_template: '{{ wait.trigger.event.data.action == action_no }}'
          sequence:
            - service: notify.mobile_app_phonetonia
              data:
                message: The No action was selected
              enabled: false
  mode: restart
